# Copyright 2025 The Knative Authors.
# SPDX-License-Identifier: Apache-2.0

name: E2E Tests on Kind

on:
  push:
    branches: [ 'main', 'release-*' ]

  pull_request:
    branches: [ 'main', 'release-*' ]

jobs:
  e2e-kind:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: wasm32-wasip2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Kind cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: knative-wasm-e2e
        node_image: kindest/node:v1.34.0
        wait: 120s

    - name: Verify cluster
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Run e2e tests
      run: ./goyek --verbose e2e
      env:
        E2E_IMAGE_BASENAME: ghcr.io/${{ github.repository }}/e2e-pr-${{ github.event.pull_request.number }}
        ARTIFACTS: ${{ github.workspace }}/artifacts

    - name: Delete e2e images from ghcr.io
      if: always()
      continue-on-error: true
      run: |
        # Delete all PR-specific images to avoid accumulation
        # Package names will be like: e2e-pr-6_runner, e2e-pr-6_controller, etc.
        PR_NUM=${{ github.event.pull_request.number }}
        REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
        PREFIX="e2e-pr-${PR_NUM}"
        
        echo "Deleting packages with prefix: ${PREFIX}"
        # List and delete all packages matching the PR prefix
        gh api "/users/${REPO_OWNER}/packages?package_type=container" --jq ".[] | select(.name | startswith(\"${PREFIX}\")) | .name" | \
        while read -r package_name; do
          echo "Deleting package: ${package_name}"
          gh api --method DELETE "/users/${REPO_OWNER}/packages/container/${package_name}" 2>/dev/null || \
            echo "Failed to delete ${package_name}"
        done
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-artifacts
        path: ${{ github.workspace }}/artifacts
        retention-days: 7
