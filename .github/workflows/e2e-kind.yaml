# Copyright 2025 The Knative Authors.
# SPDX-License-Identifier: Apache-2.0

name: E2E Tests on Kind

on:
  push:
    branches: [ 'main', 'release-*' ]

  pull_request:
    branches: [ 'main', 'release-*' ]

jobs:
  e2e-kind:
    name: E2E Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true

    - name: Set up Rust
      uses: actions-rust-lang/setup-rust-toolchain@v1
      with:
        toolchain: stable
        target: wasm32-wasip2

    - name: Set up local registry
      run: |
        # Create registry container unless it already exists
        if [ "$(docker inspect -f '{{.State.Running}}' kind-registry 2>/dev/null || true)" != 'true' ]; then
          docker run -d --restart=always -p 5001:5000 --name kind-registry registry:2
        fi

    - name: Create Kind config
      run: |
        cat > /tmp/kind-config.yaml <<EOF
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        containerdConfigPatches:
        - |-
          [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5001"]
            endpoint = ["http://kind-registry:5000"]
        - |-
          [plugins."io.containerd.grpc.v1.cri".registry.configs."kind-registry:5000".tls]
            insecure_skip_verify = true
        EOF

    - name: Create Kind cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: knative-wasm-e2e
        node_image: kindest/node:v1.34.0
        wait: 120s
        config: /tmp/kind-config.yaml

    - name: Connect registry to Kind network
      run: |
        # Connect the registry to the Kind network if not already connected
        if [ "$(docker inspect -f='{{json .NetworkSettings.Networks.kind}}' kind-registry)" = 'null' ]; then
          docker network connect kind kind-registry
        fi
        
        # Document the local registry for tools
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: local-registry-hosting
          namespace: kube-public
        data:
          localRegistryHosting.v1: |
            host: "localhost:5001"
            help: "https://kind.sigs.k8s.io/docs/user/local-registry/"
        EOF

    - name: Verify cluster
      run: |
        kubectl cluster-info
        kubectl get nodes

    - name: Run e2e tests
      run: ./goyek --verbose e2e
      env:
        E2E_IMAGE_BASENAME: localhost:5001/knative-serving-wasm
        ARTIFACTS: ${{ github.workspace }}/artifacts

    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-test-artifacts
        path: ${{ github.workspace }}/artifacts
        retention-days: 7
